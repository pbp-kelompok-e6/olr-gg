{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>News Detail - OLR.GG</title>
{% endblock meta %}

{% block content %}
<div class="bg-white w-full min-h-screen pt-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div class="mb-6">
            <a href="{% url 'main:show_main' %}"
                class="text-gray-600 hover:text-red-600 font-medium transition-colors inline-flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to News
            </a>
        </div>

        {% if user.is_authenticated %}
        {% include 'readinglist/reading_list_button.html' %}
        {% endif %}

        <!-- Loading State -->
        <div id="loading-state" class="bg-white rounded-lg border-2 border-gray-200 p-12 text-center">
            <svg class="animate-spin h-8 w-8 text-red-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <p class="text-gray-600 mt-3 font-medium">Loading news detail...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="bg-white rounded-lg border-2 border-red-200 p-12 text-center hidden">
            <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Failed to load news</h3>
            <p class="text-gray-600">Please try again later.</p>
        </div>

        <!-- Article Content -->
        <article id="article-content" class="bg-white rounded-xl border-2 border-gray-200 overflow-hidden shadow-lg hidden">

            <!-- Header Section -->
            <div class="p-6 sm:p-8">
                <div id="badges-container" class="flex flex-wrap items-center gap-2 mb-4">
                </div>

                <h1 id="article-title" class="text-3xl sm:text-4xl font-bold text-gray-900 leading-tight mb-4">
                </h1>

                <div class="flex flex-wrap items-center text-sm text-gray-500 gap-4">
                    <time id="article-date" class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </time>
                </div>
            </div>

            <!-- Featured Image -->
            <div id="featured-image-container" class="px-6 sm:px-8 hidden">
            <img id="featured-image" src="" alt=""
                class="w-full h-auto max-h-[50vh] sm:max-h-[60vh] lg:max-h-[70vh] object-contain object-center rounded-lg border-2 border-gray-200 bg-gray-50"
                loading="lazy">
            </div>
            <!-- Article Content Text -->
            <div class="p-6 sm:p-8">
                <div class="prose prose-lg max-w-none">
                    <div id="article-content-text"
                        class="text-gray-700 leading-relaxed whitespace-pre-line text-base sm:text-lg">
                    </div>
                </div>
            </div>

            <!-- Author Section -->
            <div class="border-t-2 border-gray-200 p-6 sm:p-8 bg-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-red-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Written by</p>
                        <div class="font-semibold text-gray-900">
                            <p id="article-author">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
            
          <div class="border-t border-gray-200 p-6 sm:p-8">
                <h3 class="text-xl font-semibold mb-4">Ratings & Reviews</h3>


            <!-- Tombol untuk menampilkan form -->
            {% if user.is_authenticated %}
                <button id="toggle-review-btn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mb-4">
                    Rate
                </button>
            {% endif %}
                

                <!-- Rating Form -->
                {% if user.is_authenticated %}
                <form id="rating-form" class="mb-6 bg-gray-50 rounded-lg border-2 border-gray-200 p-5 hidden">
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Rating (1-5)</label>
                            <div class="flex gap-2">
                                <input type="number" name="rating" min="1" max="5" class="w-24 px-4 py-2 bg-white border-2 border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-semibold text-center" placeholder="1-5">
                                <div class="flex items-center text-yellow-500">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Review</label>
                            <textarea name="review" rows="4" class="w-full px-4 py-3 bg-white border-2 border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Share your thoughts..."></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="inline-flex items-center px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Submit
                            </button>
                            <button type="button" id="cancel-review-btn" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                                Cancel
                            </button>
                        </div>
                    </div>
                </form>
                {% endif %}

                <!-- Ratings List -->
                <div id="ratings-list" class="space-y-4">
                </div>

                <!-- Empty State Ratings -->
                <div id="ratings-empty" class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 hidden">
                    <div class="text-5xl mb-3">‚≠ê</div>
                    <p class="text-gray-600 font-medium">No ratings yet</p>
                    <p class="text-gray-500 text-sm mt-1">Be the first to rate this article!</p>
                </div>
            </div>

            <!-- Comments -->
            <div class="border-t-2 border-gray-200 p-6 sm:p-8 bg-white">
                <h3 class="text-2xl font-bold text-gray-900 mb-6">Comments</h3>
                {% include 'comments.html' %}
            </div>
        </article>
    </div>
</div>

{% include 'readinglist/reading_list_modal.html' %}
{% include 'readinglist/reading_list_scripts.html' %}

<script>
const NEWS_ID = "{{ news.id }}";
const NEWS_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', NEWS_ID);
const IS_AUTHENTICATED = "{{ user.is_authenticated|yesno:'true,false' }}" === 'true';
window.READING_LIST_TOGGLE_ENDPOINT_BASE = "{% url 'readinglist:add_remove_news' '00000000-0000-0000-0000-000000000000' %}";
window.NEWS_STATUS_ENDPOINT_BASE = "{% url 'readinglist:get_news_list_status' '00000000-0000-0000-0000-000000000000' %}";
window.IS_AUTHENTICATED = "{{ user.is_authenticated|yesno:'true,false' }}" === 'true';
window.CURRENT_NEWS_ID = NEWS_ID;
window.NEWS_STATUS_ENDPOINT = window.NEWS_STATUS_ENDPOINT_BASE.replace('00000000-0000-0000-0000-000000000000', NEWS_ID);
window.READING_LIST_TOGGLE_ENDPOINT = window.READING_LIST_TOGGLE_ENDPOINT_BASE.replace('00000000-0000-0000-0000-000000000000', NEWS_ID);

const loadingState = document.getElementById('loading-state');
const errorState = document.getElementById('error-state');
const articleContent = document.getElementById('article-content');
const badgesContainer = document.getElementById('badges-container');
const articleTitle = document.getElementById('article-title');
const articleDate = document.getElementById('article-date');
const featuredImageContainer = document.getElementById('featured-image-container');
const featuredImage = document.getElementById('featured-image');
const articleContentText = document.getElementById('article-content-text');
const articleAuthor = document.getElementById('article-author');

// Rating form & buttons (hanya ada jika login)
const toggleReviewBtn = document.getElementById('toggle-review-btn');
if (toggleReviewBtn && !IS_AUTHENTICATED) {
    toggleReviewBtn.style.display = 'none';
}

const ratingForm = document.getElementById('rating-form');
const cancelReviewBtn = document.getElementById('cancel-review-btn');

let editMode = false;
let editingRatingId = null;

function showState(state) {
    loadingState.classList.toggle('hidden', state !== 'loading');
    errorState.classList.toggle('hidden', state !== 'error');
    articleContent.classList.toggle('hidden', state !== 'ready');
}

function getCategoryLabel(categoryCode) {
    const mapping = { basketball: 'Basketball', soccer: 'Soccer', football: 'Football', hockey: 'Hockey', volleyball: 'Volleyball', baseball: 'Baseball' };
    return mapping[categoryCode] || categoryCode;
}

function getCategoryColor(categoryCode) {
    const colors = { basketball: 'bg-orange-600', soccer: 'bg-green-600', football: 'bg-blue-600', hockey: 'bg-cyan-600', volleyball: 'bg-purple-600', baseball: 'bg-red-600' };
    return colors[categoryCode] || 'bg-gray-600';
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            if (cookie.trim().startsWith(name + '=')) cookieValue = decodeURIComponent(cookie.trim().substring(name.length + 1));
        });
    }
    return cookieValue;
}

function showTemporaryMessage(text) {
    const existing = document.getElementById('toast-notification');
    if (existing) existing.remove();
    const toast = document.createElement('div');
    toast.id = 'toast-notification';
    toast.className = 'fixed bottom-4 right-4 bg-blue-600 text-white px-5 py-3 rounded-lg shadow-xl z-50 transition-opacity font-semibold';
    toast.textContent = text;
    document.body.appendChild(toast);
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 2500);
}

// Render article detail
function renderArticle(news) {
    articleTitle.textContent = news.title;
    document.title = `${news.title} - OLR.GG`;

    badgesContainer.innerHTML = '';
    const categoryBadge = document.createElement('span');
    categoryBadge.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold text-white ${getCategoryColor(news.category)}`;
    categoryBadge.textContent = getCategoryLabel(news.category);
    badgesContainer.appendChild(categoryBadge);

    if (news.is_featured) {
        const featuredBadge = document.createElement('span');
        featuredBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border-2 border-yellow-300';
        featuredBadge.innerHTML = '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg> Featured';
        badgesContainer.appendChild(featuredBadge);
    }

    const formattedDate = new Date(news.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    articleDate.innerHTML += ` ${formattedDate}`;

    if (news.thumbnail) {
        featuredImage.src = news.thumbnail;
        featuredImage.alt = news.title;
        featuredImageContainer.classList.remove('hidden');
    } else featuredImageContainer.classList.add('hidden');

    articleContentText.textContent = news.content;
    const authorName = news.user_username || 'Anonymous';
    const linkAuthorProfile = `{% url 'users:show_profile' '0' %}`.replace('0', news.user_id);
    articleAuthor.innerHTML = `<a href="${linkAuthorProfile}" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors">${authorName}</a>`;
}

// Load article data
async function loadNewsDetail() {
    try {
        showState('loading');
        const response = await fetch(NEWS_DETAIL_ENDPOINT, { headers: { 'Accept': 'application/json' } });
        if (!response.ok) throw new Error(response.status === 404 ? 'News not found (404)' : 'Failed to fetch news detail');

        const newsData = await response.json();
        renderArticle(newsData);
        showState('ready');
    } catch (error) {
        console.error(error);
        showState('error');
    }
}

// Load ratings
function loadRatings() {
    const ratingsList = document.getElementById('ratings-list');
    const ratingsEmpty = document.getElementById('ratings-empty');

    fetch(`/rating/get/${NEWS_ID}/`)
        .then(res => res.json())
        .then(ratings => {
            if (ratings.length === 0) {
                ratingsList.classList.add('hidden');
                ratingsEmpty.classList.remove('hidden');
                return;
            }
            ratingsList.classList.remove('hidden');
            ratingsEmpty.classList.add('hidden');
            ratingsList.innerHTML = ratings.map(rating => `
                <div class="border-2 border-gray-200 rounded-lg p-4 bg-gray-50 hover:border-blue-300 transition-colors" id="rating-${rating.id}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <div class="flex items-center bg-yellow-100 px-3 py-1 rounded-full border-2 border-yellow-300">
                                    <svg class="w-4 h-4 text-yellow-600 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                    <span class="text-lg font-bold text-yellow-800">${rating.rating}/5</span>
                                </div>
                                <span class="text-sm font-semibold text-gray-700">${rating.user_username}</span>
                            </div>
                            <p class="mt-2 text-gray-800 leading-relaxed">${rating.review}</p>
                        </div>
                        ${IS_AUTHENTICATED && rating.can_edit ? `
                            <div class="flex gap-2 ml-4">
                                <button onclick="editRating(${rating.id})" class="text-blue-600 hover:text-blue-800 font-semibold text-sm transition-colors">Edit</button>
                                <button onclick="deleteRating(${rating.id})" class="text-red-600 hover:text-red-800 font-semibold text-sm transition-colors">Delete</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        });
}

// Rating form submission
if (ratingForm) {
    ratingForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const endpoint = editMode ? `/rating/edit/${editingRatingId}/` : `/rating/add/${NEWS_ID}/`;

        fetch(endpoint, {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'success') {
                loadRatings();
                this.reset();
                editMode = false;
                editingRatingId = null;
                ratingForm.classList.add('hidden');
                if (toggleReviewBtn) toggleReviewBtn.classList.remove('hidden');
                showTemporaryMessage(editMode ? 'Rating updated!' : 'Rating added!');
            } else alert(data.message || 'Error submitting review');
        });
    });
}

// Rating edit/delete functions
function deleteRating(ratingId) {
    if (!IS_AUTHENTICATED) return;
    if (confirm('Are you sure you want to delete this rating?')) {
        fetch(`/rating/delete/${ratingId}/`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': getCookie('csrftoken') }
        }).then(res => res.json()).then(data => {
            if (data.status === 'success') {
                loadRatings();
                showTemporaryMessage('Rating deleted');
            }
        });
    }
}

function editRating(ratingId) {
    if (!ratingForm) return;
    const ratingElement = document.getElementById(`rating-${ratingId}`);
    const ratingValue = ratingElement.querySelector('.text-lg.font-bold').textContent.split('/')[0].trim();
    const reviewText = ratingElement.querySelector('.text-gray-800').textContent.trim();

    ratingForm.querySelector('input[name="rating"]').value = ratingValue;
    ratingForm.querySelector('textarea[name="review"]').value = reviewText;
    ratingForm.classList.remove('hidden');
    if (toggleReviewBtn) toggleReviewBtn.classList.add('hidden');

    editMode = true;
    editingRatingId = ratingId;
}

if (toggleReviewBtn && ratingForm && cancelReviewBtn) {
    toggleReviewBtn.addEventListener('click', () => {
        ratingForm.classList.remove('hidden');
        toggleReviewBtn.classList.add('hidden');
    });
    cancelReviewBtn.addEventListener('click', () => {
        ratingForm.classList.add('hidden');
        toggleReviewBtn.classList.remove('hidden');
        ratingForm.reset();
        editMode = false;
        editingRatingId = null;
    });
}

    loadNewsDetail();
    loadRatings();
</script>
{% endblock content %}