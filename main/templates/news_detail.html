{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>News Detail - OLR.GG</title>
{% endblock meta %}

{% block content %}
<div class="bg-white w-full min-h-screen pt-16">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <div class="mb-6">
            <a href="{% url 'main:show_main' %}"
                class="text-gray-600 hover:text-red-600 font-medium transition-colors inline-flex items-center">
                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to News
            </a>
        </div>

        {% if user.is_authenticated %}
        {% include 'readinglist/reading_list_button.html' %}
        {% endif %}

        <!-- Loading State -->
        <div id="loading-state" class="bg-white rounded-lg border-2 border-gray-200 p-12 text-center">
            <svg class="animate-spin h-8 w-8 text-red-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
            </svg>
            <p class="text-gray-600 mt-3 font-medium">Loading news detail...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="bg-white rounded-lg border-2 border-red-200 p-12 text-center hidden">
            <div class="w-16 h-16 mx-auto mb-4 bg-red-100 rounded-full flex items-center justify-center">
                <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Failed to load news</h3>
            <p class="text-gray-600">Please try again later.</p>
        </div>

        <!-- Article Content -->
        <article id="article-content" class="bg-white rounded-xl border-2 border-gray-200 overflow-hidden shadow-lg hidden">

            <!-- Header Section -->
            <div class="p-6 sm:p-8">
                <div id="badges-container" class="flex flex-wrap items-center gap-2 mb-4">
                </div>

                <h1 id="article-title" class="text-3xl sm:text-4xl font-bold text-gray-900 leading-tight mb-4">
                </h1>

                <div class="flex flex-wrap items-center text-sm text-gray-500 gap-4">
                    <time id="article-date" class="flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                    </time>
                </div>
            </div>

            <!-- Featured Image -->
            <div id="featured-image-container" class="px-6 sm:px-8 hidden">
                <img id="featured-image" src="" alt="" class="w-full h-64 sm:h-80 lg:h-96 object-cover rounded-lg border-2 border-gray-200">
            </div>

            <!-- Article Content Text -->
            <div class="p-6 sm:p-8">
                <div class="prose prose-lg max-w-none">
                    <div id="article-content-text"
                        class="text-gray-700 leading-relaxed whitespace-pre-line text-base sm:text-lg">
                    </div>
                </div>
            </div>

            <!-- Author Section -->
            <div class="border-t-2 border-gray-200 p-6 sm:p-8 bg-gray-50">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-gradient-to-br from-blue-600 to-red-600 rounded-full flex items-center justify-center text-white font-bold text-lg">
                        <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 font-medium">Written by</p>
                        <div class="font-semibold text-gray-900">
                            <p id="article-author">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ratings Section -->
            <div class="border-t-2 border-gray-200 p-6 sm:p-8 bg-white">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-2xl font-bold text-gray-900">Ratings & Reviews</h3>
                    <button id="toggle-review-btn" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                        </svg>
                        Add Rating
                    </button>
                </div>

                <!-- Add Rating Form -->
                <form id="rating-form" class="mb-6 bg-gray-50 rounded-lg border-2 border-gray-200 p-5 hidden">
                    {% csrf_token %}
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Rating (1-5)</label>
                            <div class="flex gap-2">
                                <input type="number" name="rating" min="1" max="5" class="w-24 px-4 py-2 bg-white border-2 border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-semibold text-center" placeholder="1-5">
                                <div class="flex items-center text-yellow-500">
                                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Review</label>
                            <textarea name="review" rows="4" class="w-full px-4 py-3 bg-white border-2 border-gray-300 text-gray-900 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="Share your thoughts..."></textarea>
                        </div>
                        <div class="flex gap-3">
                            <button type="submit" class="inline-flex items-center px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors shadow-md">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                                Submit
                            </button>
                            <button type="button" id="cancel-review-btn" class="px-5 py-2.5 border-2 border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-semibold">
                                Cancel
                            </button>
                        </div>
                    </div>
                </form>

                <!-- Ratings List -->
                <div id="ratings-list" class="space-y-4">
                    <!-- Ratings will be inserted here -->
                </div>

                <!-- Empty State for Ratings -->
                <div id="ratings-empty" class="text-center py-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 hidden">
                    <div class="text-5xl mb-3">‚≠ê</div>
                    <p class="text-gray-600 font-medium">No ratings yet</p>
                    <p class="text-gray-500 text-sm mt-1">Be the first to rate this article!</p>
                </div>
            </div>

            <!-- Comments Section -->
            <div class="border-t-2 border-gray-200 p-6 sm:p-8 bg-white">
                <h3 class="text-2xl font-bold text-gray-900 mb-6">Comments</h3>
                {% include 'comments.html' %}
            </div>
        </article>
    </div>
</div>

{% include 'readinglist/reading_list_modal.html' %}

<script>
    // Configuration
    const NEWS_ID = "{{ news.id }}";
    const NEWS_DETAIL_ENDPOINT = `{% url 'main:show_json_by_id' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', NEWS_ID);
    const READING_LIST_TOGGLE_ENDPOINT = `{% url 'readinglist:add_remove_news' news.id %}`;
    const NEWS_STATUS_ENDPOINT = `{% url 'readinglist:get_news_list_status' news.id %}`;
    const IS_AUTHENTICATED = "{{ user.is_authenticated|yesno:'true,false' }}" === 'true';

    // DOM Elements
    const loadingState = document.getElementById('loading-state');
    const errorState = document.getElementById('error-state');
    const articleContent = document.getElementById('article-content');
    const badgesContainer = document.getElementById('badges-container');
    const articleTitle = document.getElementById('article-title');
    const articleDate = document.getElementById('article-date');
    const featuredImageContainer = document.getElementById('featured-image-container');
    const featuredImage = document.getElementById('featured-image');
    const articleContentText = document.getElementById('article-content-text');
    const articleAuthor = document.getElementById('article-author');
    const addToReadingListBtn = document.getElementById('add-to-reading-list-btn');
    const readingListStatusText = document.getElementById('reading-list-status-text');
    const readingListModal = document.getElementById('readingListModal');
    const listOptionsContainer = document.getElementById('list-options-container');
    const listLoadingStatus = document.getElementById('list-loading-status');

    // Show/hide page sections
    function showState(state) {
        loadingState.classList.toggle('hidden', state !== 'loading');
        errorState.classList.toggle('hidden', state !== 'error');
        articleContent.classList.toggle('hidden', state !== 'ready');
    }

    // Get readable category name
    function getCategoryLabel(categoryCode) {
        const categoryMapping = {
            basketball: 'Basketball',
            soccer: 'Soccer',
            football: 'Football',
            hockey: 'Hockey',
            volleyball: 'Volleyball',
            baseball: 'Baseball',
        };
        return categoryMapping[categoryCode] || categoryCode;
    }

    function getCategoryColor(categoryCode) {
        const categoryColors = {
            basketball: 'bg-orange-600',
            soccer: 'bg-green-600',
            football: 'bg-blue-600',
            hockey: 'bg-cyan-600',
            volleyball: 'bg-purple-600',
            baseball: 'bg-red-600',
        };
        return categoryColors[categoryCode] || 'bg-gray-600';
    }

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function updateMainButtonAppearance(isInAnyList) {
        if (!addToReadingListBtn) return;

        // Remove all possible color classes first
        addToReadingListBtn.classList.remove(
            'border-blue-600', 'text-blue-600', 'hover:bg-blue-600',
            'border-red-600', 'text-red-600', 'hover:bg-red-600'
        );

        if (isInAnyList) {
            // Already in list - show red (remove)
            readingListStatusText.textContent = "Remove from List";
            addToReadingListBtn.classList.add('border-red-600', 'text-red-600', 'hover:bg-red-600');
        } else {
            // Not in list - show blue (add)
            readingListStatusText.textContent = "+ Reading List";
            addToReadingListBtn.classList.add('border-blue-600', 'text-blue-600', 'hover:bg-blue-600');
        }
    }

    function openReadingListModal() {
        if (!IS_AUTHENTICATED) return;
        readingListModal.classList.remove('hidden');
        fetchReadingListStatus();
    }

    function closeReadingListModal() {
        readingListModal.classList.add('hidden');
    }

    async function handleListToggleFromModal(listId, listName, wasInList, button) {
        button.disabled = true;

        try {
            const response = await fetch(READING_LIST_TOGGLE_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ list_id: listId, news_id: NEWS_ID })
            });

            const result = await response.json();

            if (response.ok) {
                const isNowInList = !wasInList;
                const statusText = isNowInList ? 'Remove' : 'Add';

                // Update button appearance
                button.className = `w-full text-left p-4 rounded-lg transition-all duration-200 flex justify-between items-center border-2 font-medium ${isNowInList
                    ? 'bg-red-50 hover:bg-red-100 text-red-700 border-red-300 shadow-md'
                    : 'bg-blue-50 hover:bg-blue-100 text-blue-700 border-blue-300 shadow-md hover:shadow-lg'
                }`;

                const nameSpan = document.createElement('span');
                nameSpan.className = 'font-semibold text-base';
                nameSpan.textContent = listName;

                const statusSpan = document.createElement('span');
                statusSpan.className = `text-xs font-bold uppercase px-3 py-1.5 rounded-full ${isNowInList 
                    ? 'bg-red-200 text-red-800 border border-red-300' 
                    : 'bg-blue-200 text-blue-800 border border-blue-300'
                }`;
                statusSpan.textContent = statusText;

                button.innerHTML = '';
                button.appendChild(nameSpan);
                button.appendChild(statusSpan);
                button.onclick = () => handleListToggleFromModal(listId, listName, isNowInList, button);

                const allButtons = listOptionsContainer.querySelectorAll('button');
                let isInAnyList = false;

                allButtons.forEach(btn => {
                    if (btn.classList.contains('bg-red-50')) {
                        isInAnyList = true;
                    }
                });

                updateMainButtonAppearance(isInAnyList);
                showTemporaryMessage(isNowInList ? `Added to "${listName}"` : `Removed from "${listName}"`);

            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            console.error('Error toggling list item:', error);
            alert('An unexpected error occurred.');
        } finally {
            button.disabled = false;
        }
    }

    function showTemporaryMessage(text) {
        const existing = document.getElementById('toast-notification');
        if (existing) existing.remove();

        const toast = document.createElement('div');
        toast.id = 'toast-notification';
        toast.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-5 py-3 rounded-lg shadow-xl z-50 transition-opacity font-semibold';
        toast.textContent = text;
        document.body.appendChild(toast);

        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }

    async function fetchReadingListStatus() {
        if (!IS_AUTHENTICATED) return;

        const isModalVisible = !readingListModal.classList.contains('hidden');

        if (isModalVisible) {
            listOptionsContainer.innerHTML = '';
            listLoadingStatus.classList.remove('hidden');
            listLoadingStatus.textContent = 'Loading lists...';
        }

        try {
            const response = await fetch(NEWS_STATUS_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });

            const lists = await response.json();

            if (!response.ok) {
                if (isModalVisible) {
                    listLoadingStatus.textContent = `Failed to load lists: ${lists.message || 'Error'}`;
                }
                return;
            }

            if (isModalVisible) {
                renderListOptions(lists);
            }

            const isInAnyList = lists.some(list => list.is_in_list);
            updateMainButtonAppearance(isInAnyList);

        } catch (error) {
            if (isModalVisible) {
                listLoadingStatus.textContent = 'Failed to connect to server.';
            }
            console.error('Error fetching list status:', error);
        }
    }

    function renderListOptions(lists) {
        listOptionsContainer.innerHTML = '';
        listLoadingStatus.classList.add('hidden');

        if (lists.length === 0) {
            listOptionsContainer.innerHTML = '<p class="text-gray-500 italic text-center py-4">You don\'t have any reading lists yet.</p>';
            return;
        }

        lists.forEach(list => {
            const button = document.createElement('button');
            const isInList = list.is_in_list;
            const statusText = isInList ? 'Remove' : 'Add';

            button.className = `w-full text-left p-4 rounded-lg transition-all duration-200 flex justify-between items-center border-2 font-medium ${isInList
                ? 'bg-red-50 hover:bg-red-100 text-red-700 border-red-300 shadow-md'
                : 'bg-blue-50 hover:bg-blue-100 text-blue-700 border-blue-300 shadow-md hover:shadow-lg'
            }`;

            const nameSpan = document.createElement('span');
            nameSpan.className = 'font-semibold text-base';
            nameSpan.textContent = list.name;

            const statusSpan = document.createElement('span');
            statusSpan.className = `text-xs font-bold uppercase px-3 py-1.5 rounded-full ${isInList 
                ? 'bg-red-200 text-red-800 border border-red-300' 
                : 'bg-blue-200 text-blue-800 border border-blue-300'
            }`;
            statusSpan.textContent = statusText;

            button.appendChild(nameSpan);
            button.appendChild(statusSpan);
            button.onclick = () => handleListToggleFromModal(list.id, list.name, isInList, button);

            listOptionsContainer.appendChild(button);
        });
    }

    if (addToReadingListBtn) {
        addToReadingListBtn.addEventListener('click', openReadingListModal);
    }

    // Render article content
    function renderArticle(news) {
        articleTitle.textContent = news.title;
        document.title = `${news.title} - OLR.GG`;

        badgesContainer.innerHTML = '';

        const categoryBadge = document.createElement('span');
        categoryBadge.className = `inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold text-white ${getCategoryColor(news.category)}`;
        categoryBadge.textContent = getCategoryLabel(news.category);
        badgesContainer.appendChild(categoryBadge);

        if (news.is_featured) {
            const featuredBadge = document.createElement('span');
            featuredBadge.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold bg-yellow-100 text-yellow-800 border-2 border-yellow-300';
            featuredBadge.innerHTML = '<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg> Featured';
            badgesContainer.appendChild(featuredBadge);
        }

        const formattedDate = new Date(news.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
        articleDate.innerHTML += ` ${formattedDate}`;

        if (news.thumbnail) {
            featuredImage.src = news.thumbnail;
            featuredImage.alt = news.title;
            featuredImageContainer.classList.remove('hidden');
        } else {
            featuredImageContainer.classList.add('hidden');
        }

        articleContentText.textContent = news.content;

        const authorName = news.user_username || 'Anonymous';
        const linkAuthorProfile = `{% url 'users:show_profile' '0' %}`.replace('0', news.user_id);
        articleAuthor.innerHTML = `<a href="${linkAuthorProfile}" class="text-blue-600 hover:text-blue-800 font-semibold transition-colors">${authorName}</a>`;
    }

    // Fetch news detail
    async function loadNewsDetail() {
        try {
            showState('loading');

            const response = await fetch(NEWS_DETAIL_ENDPOINT, {
                headers: { 'Accept': 'application/json' },
            });

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('News not found (404)');
                }
                throw new Error('Failed to fetch news detail');
            }

            const newsData = await response.json();
            renderArticle(newsData);

            if (IS_AUTHENTICATED) {
                await fetchReadingListStatus();
            }

            showState('ready');
        } catch (error) {
            console.error('Error loading news detail:', error);
            showState('error');
        }
    }

    // Load ratings
    function loadRatings() {
        fetch(`/rating/get/${NEWS_ID}/`)
            .then(response => response.json())
            .then(ratings => {
                const ratingsList = document.getElementById('ratings-list');
                const ratingsEmpty = document.getElementById('ratings-empty');
                
                if (ratings.length === 0) {
                    ratingsList.classList.add('hidden');
                    ratingsEmpty.classList.remove('hidden');
                    return;
                }
                
                ratingsList.classList.remove('hidden');
                ratingsEmpty.classList.add('hidden');
                
                ratingsList.innerHTML = ratings.map(rating => `
                    <div class="border-2 border-gray-200 rounded-lg p-4 bg-gray-50 hover:border-blue-300 transition-colors" id="rating-${rating.id}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <div class="flex items-center bg-yellow-100 px-3 py-1 rounded-full border-2 border-yellow-300">
                                        <svg class="w-4 h-4 text-yellow-600 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                                        </svg>
                                        <span class="text-lg font-bold text-yellow-800">${rating.rating}/5</span>
                                    </div>
                                    <span class="text-sm font-semibold text-gray-700">${rating.user_username}</span>
                                </div>
                                <p class="mt-2 text-gray-800 leading-relaxed">${rating.review}</p>
                            </div>
                            ${rating.can_edit ? `
                                <div class="flex gap-2 ml-4">
                                    <button onclick="editRating(${rating.id})" class="text-blue-600 hover:text-blue-800 font-semibold text-sm transition-colors">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                        Edit
                                    </button>
                                    <button onclick="deleteRating(${rating.id})" class="text-red-600 hover:text-red-800 font-semibold text-sm transition-colors">
                                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                        Delete
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `).join('');
            });
    }

    // Handle rating form submission
    document.getElementById('rating-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        const endpoint = editMode 
            ? `/rating/edit/${editingRatingId}/` 
            : `/rating/add/${NEWS_ID}/`;

        fetch(endpoint, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                loadRatings();
                this.reset();
                editMode = false;
                editingRatingId = null;
                ratingForm.classList.add('hidden');
                toggleReviewBtn.classList.remove('hidden');
                showTemporaryMessage(editMode ? 'Rating updated!' : 'Rating added!');
            } 
            else {
                alert(data.message || 'Error submitting review');
            }
        });
    });

    function deleteRating(ratingId) {
        if (confirm('Are you sure you want to delete this rating?')) {
            fetch(`/rating/delete/${ratingId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    loadRatings();
                    showTemporaryMessage('Rating deleted');
                }
            });
        }
    }

    function editRating(ratingId) {
        const ratingElement = document.querySelector(`#rating-${ratingId}`);
        const ratingValue = ratingElement.querySelector('.text-lg.font-bold').textContent.split('/')[0].trim();
        const reviewText = ratingElement.querySelector('.text-gray-800').textContent.trim();

        const ratingInput = ratingForm.querySelector('input[name="rating"]');
        const reviewInput = ratingForm.querySelector('textarea[name="review"]');
        ratingInput.value = ratingValue;
        reviewInput.value = reviewText;

        ratingForm.classList.remove('hidden');
        toggleReviewBtn.classList.add('hidden');

        editMode = true;
        editingRatingId = ratingId;
    }

    // Toggle review form
    const toggleReviewBtn = document.getElementById('toggle-review-btn');
    const ratingForm = document.getElementById('rating-form');
    const cancelReviewBtn = document.getElementById('cancel-review-btn');

    toggleReviewBtn.addEventListener('click', () => {
        ratingForm.classList.remove('hidden');
        toggleReviewBtn.classList.add('hidden');
    });

    cancelReviewBtn.addEventListener('click', () => {
        ratingForm.classList.add('hidden');
        toggleReviewBtn.classList.remove('hidden');
        ratingForm.reset();
        editMode = false;
        editingRatingId = null;
    });

    let editMode = false;
    let editingRatingId = null;

    // Initialize page
    loadNewsDetail();
    loadRatings();
</script>
{% endblock content %}