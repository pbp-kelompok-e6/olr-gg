{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container" style="max-width: 900px; margin: 40px auto;">

  <a href="{% url 'forum:forum_view' %}" class="btn btn-secondary mb-3">‚Üê Back to Forum</a>

  <div class="card mb-4">
    <div class="card-body">
      <div id="post-display-area">
        <h2 id="post-title-display">{{ post.title }}</h2>
        <p class="text-muted">By {{ post.author.username }} on {{ post.created_at|date:"F d, Y" }}</p>
        <hr>
        <p id="post-content-display">{{ post.content|linebreaksbr }}</p>
      </div>

      <form id="edit-post-form" style="display: none;">
        <div class="mb-3">
          <label for="edit-post-title" class="form-label">Edit Title</label>
          <input type="text" id="edit-post-title" class="form-control" value="{{ post.title }}">
        </div>
        <div class="mb-3">
          <label for="edit-post-content" class="form-label">Edit Description</label>
          <textarea id="edit-post-content" class="form-control" rows="5">{{ post.content }}</textarea>
        </div>
        <button type="submit" class="btn btn-success">Save Changes</button>
        <button type="button" id="cancel-edit-post-btn" class="btn btn-secondary">Cancel</button>
      </form>
      
      {% if post.author == user %}
        <div id="author-buttons" class="mt-3">
          <button id="edit-post-btn" class="btn btn-outline-primary">Edit Post</button>
          <button id="delete-post-btn" class="btn btn-outline-danger">Delete Post</button>
        </div>
      {% endif %}
    </div>
  </div>

  <div class="card">
    <div class="card-body">
      <h4>Comments</h4>
      <hr>
      <form id="create-comment-form" class="mb-4">
        {% csrf_token %}
        <div class="input-group">
          <input type="text" id="comment-content-input" class="form-control" placeholder="Write a comment..." required>
          <button class="btn btn-primary" type="submit">Post</button>
        </div>
      </form>

      <div id="comment-list">
        {% for comment in comments %}
          <div class="card card-body mb-2" id="comment-{{ comment.id }}">
            <div id="comment-display-{{ comment.id }}">
              <p>{{ comment.content }}</p>
              <small class="text-muted">-- {{ comment.author.username }}</small>
            </div>
            <form class="edit-comment-form" data-comment-id="{{ comment.id }}" style="display: none;">
              <textarea class="form-control mb-2">{{ comment.content }}</textarea>
              <button type="submit" class="btn btn-sm btn-success">Save</button>
              <button type="button" class="btn btn-sm btn-secondary cancel-edit-comment-btn">Cancel</button>
            </form>

            {% if comment.author == user %}
              <div class="mt-2">
                <button class="btn btn-sm btn-outline-secondary edit-comment-btn" data-comment-id="{{ comment.id }}">Edit</button>
                <button class="btn btn-sm btn-outline-danger delete-comment-btn" data-comment-id="{{ comment.id }}">Delete</button>
              </div>
            {% endif %}
          </div>
        {% empty %}
          <p id="no-comments-message">No comments yet. Be the first to reply!</p>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const postId = "{{ post.id }}";

  // --- POST AJAX ---
  const editPostBtn = document.getElementById('edit-post-btn');
  const deletePostBtn = document.getElementById('delete-post-btn');
  const editPostForm = document.getElementById('edit-post-form');

  if (editPostBtn) {
    editPostBtn.addEventListener('click', () => {
      document.getElementById('post-display-area').style.display = 'none';
      document.getElementById('author-buttons').style.display = 'none';
      editPostForm.style.display = 'block';
    });
    
    document.getElementById('cancel-edit-post-btn').addEventListener('click', () => {
      document.getElementById('post-display-area').style.display = 'block';
      document.getElementById('author-buttons').style.display = 'block';
      editPostForm.style.display = 'none';
    });

    editPostForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const title = document.getElementById('edit-post-title').value;
      const content = document.getElementById('edit-post-content').value;
      
      fetch("{% url 'forum:edit_post_ajax' post.id %}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({title, content})
      })
      .then(res => res.json())
      .then(data => {
        if(data.status === 'success') {
          document.getElementById('post-title-display').textContent = data.post.title;
          document.getElementById('post-content-display').innerHTML = data.post.content.replace(/\n/g, '<br>');
          document.getElementById('cancel-edit-post-btn').click(); 
        }
      });
    });
  }

  if (deletePostBtn) {
    deletePostBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to delete this post? This cannot be undone.')) {
        fetch("{% url 'forum:delete_post_ajax' post.id %}", {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken}
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') {
            window.location.href = data.redirect_url;
          }
        });
      }
    });
  }


  // --- COMMENT AJAX ---
  const commentList = document.getElementById('comment-list');

  // 1. Create Comment
  document.getElementById('create-comment-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const contentInput = document.getElementById('comment-content-input');
    
    fetch("{% url 'forum:create_comment_ajax' post.id %}", {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
      body: JSON.stringify({ content: contentInput.value })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const newComment = document.createElement('div');
        newComment.className = 'card card-body mb-2';
        newComment.id = `comment-${data.comment.id}`;
        newComment.innerHTML = `
          <div id="comment-display-${data.comment.id}">
              <p>${data.comment.content}</p>
              <small class="text-muted">-- ${data.comment.author}</small>
          </div>
          <form class="edit-comment-form" data-comment-id="${data.comment.id}" style="display: none;">
            <textarea class="form-control mb-2">${data.comment.content}</textarea>
            <button type="submit" class="btn btn-sm btn-success">Save</button>
            <button type="button" class="btn btn-sm btn-secondary cancel-edit-comment-btn">Cancel</button>
          </form>
          <div class="mt-2">
              <button class="btn btn-sm btn-outline-secondary edit-comment-btn" data-comment-id="${data.comment.id}">Edit</button>
              <button class="btn btn-sm btn-outline-danger delete-comment-btn" data-comment-id="${data.comment.id}">Delete</button>
          </div>
        `;
        commentList.appendChild(newComment);
        document.getElementById('no-comments-message')?.remove();
        contentInput.value = '';
      }
    });
  });

  // Event delegation untuk edit/delete/save/cancel pada komentar
  commentList.addEventListener('click', (e) => {
    const commentId = e.target.dataset.commentId;
    if (!commentId) return;

    const commentCard = document.getElementById(`comment-${commentId}`);
    const displayDiv = document.getElementById(`comment-display-${commentId}`);
    const editForm = commentCard.querySelector('.edit-comment-form');

    // 2. Delete Comment
    if (e.target.matches('.delete-comment-btn')) {
      if (confirm('Delete this comment?')) {
        const url = "{% url 'forum:delete_comment_ajax' 0 %}".replace('0', commentId);
        fetch(url, {
          method: 'POST',
          headers: {'X-CSRFToken': csrftoken}
        })
        .then(res => res.json())
        .then(data => {
          if (data.status === 'success') commentCard.remove();
        });
      }
    }
    
    if (e.target.matches('.edit-comment-btn')) {
      displayDiv.style.display = 'none';
      editForm.style.display = 'block';
    }

    if (e.target.matches('.cancel-edit-comment-btn')) {
      displayDiv.style.display = 'block';
      editForm.style.display = 'none';
    }
  });

  commentList.addEventListener('submit', (e) => {
    e.preventDefault();
    const commentId = e.target.dataset.commentId;
    if (!commentId || !e.target.matches('.edit-comment-form')) return;

    const content = e.target.querySelector('textarea').value;
    
    const url = "{% url 'forum:edit_comment_ajax' 0 %}".replace('0', commentId);
    fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
      body: JSON.stringify({ content })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === 'success') {
        const displayDiv = document.getElementById(`comment-display-${commentId}`);
        displayDiv.querySelector('p').textContent = data.comment.content;
        e.target.style.display = 'none';
        displayDiv.style.display = 'block';
      }
    });
  });
});
</script>
{% endblock %}