{% extends 'base.html' %}
{% load static %}

{% block meta %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    .filter-btn {
      background-color: #f3f4f6; /* gray-100 */
      color: #374151; /* gray-700 */
      transition: background-color 0.2s, color 0.2s;
    }
    .filter-btn.active-filter, .filter-btn:hover {
      background-color: #3b82f6; /* blue-500 */
      color: white;
    }
  </style>
{% endblock meta %}

{% block content %}
<div class="bg-gray-100 min-h-screen pt-16">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <div class="mb-6">
        <a href="{% url 'main:show_main' %}"
            class="text-gray-600 hover:text-blue-600 font-medium transition-colors inline-flex items-center">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Home
        </a>
    </div>

    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-4xl font-extrabold text-gray-900 mb-2 border-b-4 border-blue-600 inline-block pr-8 pb-1">
                Discussions
            </h1>
            <p class="text-gray-600 text-lg mt-2">Engage with the community on the latest sports topics</p>
        </div>
        <div class="flex items-center gap-4">
            <button id="show-form-btn" class="inline-flex items-center px-5 py-2.5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-all duration-200 shadow-md hover:shadow-lg">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                Create Discussion
            </button>
        </div>
    </div>

    <div class="bg-white rounded-xl border border-gray-200 p-6 mb-8 shadow-sm" id="create-post-card" style="display: none;">
      <h5 class="text-xl font-semibold text-gray-800 mb-4">Start a New Discussion</h5>
      <form id="create-post-form">
        {% csrf_token %}
        <div class="mb-4">
          <label for="post-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
          <input type="text" id="post-title" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
        </div>
        
        <div class="mb-4">
          <label for="post-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
          <select id="post-category" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
            <option value="" disabled selected>Select a sport</option>
            <option value="soccer">Soccer</option>
            <option value="basketball">Basketball</option>
            <option value="football">Football</option>
            <option value="hockey">Hockey</option>
            <option value="volleyball">Volleyball</option>
            <option value="baseball">Baseball</option>
          </select>
        </div>

        <div class="mb-4">
          <label for="post-content" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea id="post-content" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required></textarea>
        </div>
        <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-5 rounded-lg hover:bg-blue-700 transition-colors">
          Post Discussion
        </button>
      </form>
    </div>

    <div class="mb-6">
        <div id="filter-buttons" class="flex flex-wrap items-center gap-2 bg-white p-3 rounded-xl border border-gray-200">
            <button data-filter="all" class="filter-btn active-filter px-4 py-1.5 text-sm font-semibold rounded-lg">All</button>
            <button data-filter="soccer" class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-lg">Soccer</button>
            <button data-filter="basketball" class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-lg">Basketball</button>
            <button data-filter="football" class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-lg">Football</button>
            <button data-filter="hockey" class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-lg">Hockey</button>
            <button data-filter="volleyball" class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-lg">Volleyball</button>
            <button data-filter="baseball" class="filter-btn px-4 py-1.5 text-sm font-semibold rounded-lg">Baseball</button>
        </div>
    </div>

    <div class="space-y-4" id="post-list-container">
      {% for post in posts %}
        <a href="{% url 'forum:post_detail_view' post.id %}" id="post-{{ post.id }}" class="post-card block bg-white p-5 rounded-xl border border-gray-200 transition-shadow duration-200 hover:shadow-md" data-category="{{ post.category }}">
          <div class="flex justify-between items-start gap-4">
            <div class="flex-grow">
              <div class="flex items-center gap-3 mb-1">
                <h5 class="text-lg font-semibold text-gray-900 break-words">{{ post.title }}</h5>
                <span class="category-badge inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-500 text-white">
                  {{ post.get_category_display }}
                </span>
              </div>
              <p class="text-sm text-gray-600 mt-1">Started by {{ post.author.username }}</p>
              <span class="text-sm font-medium text-blue-600 mt-3 inline-block">
                View More â†’
              </span>
            </div>
            <div class="text-right flex-shrink-0">
              <small class="text-sm text-gray-500">{{ post.comments.count }} comments</small>
              {% if post.author == user %}
                <div class="flex items-center gap-3 mt-2 justify-end">
                  <button class="text-xs font-medium text-blue-600 hover:text-blue-800 edit-post-btn" 
                          data-post-id="{{ post.id }}" 
                          data-post-title="{{ post.title }}" 
                          data-post-content="{{ post.content }}"
                          data-post-category="{{ post.category }}">Edit</button>
                  <button class="text-xs font-medium text-red-600 hover:text-red-800 delete-post-btn" data-post-id="{{ post.id }}">Delete</button>
                </div>
              {% endif %}
            </div>
          </div>
        </a>
      {% empty %}
        <div id="no-posts-message" class="bg-white text-center p-12 rounded-xl border border-gray-200">
          <p class="text-gray-500">No discussions have been started yet.</p>
        </div>
      {% endfor %}
    </div>
  </div>
</div>

<div id="edit-post-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" style="display: none;">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg">
    <div class="p-6">
      <h5 class="text-xl font-semibold text-gray-800 mb-4">Edit Discussion</h5>
      <form id="edit-post-modal-form">
        <input type="hidden" id="edit-post-id-input">
        <div class="mb-4">
          <label for="edit-post-title-input" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
          <input type="text" id="edit-post-title-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
        </div>

        <div class="mb-4">
            <label for="edit-post-category-input" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
            <select id="edit-post-category-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                <option value="soccer">Soccer</option>
                <option value="basketball">Basketball</option>
                <option value="football">Football</option>
                <option value="hockey">Hockey</option>
                <option value="volleyball">Volleyball</option>
                <option value="baseball">Baseball</option>
            </select>
        </div>

        <div class="mb-4">
          <label for="edit-post-content-input" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
          <textarea id="edit-post-content-input" rows="5" class="w-full px-3 py-2 border border-gray-300 rounded-md" required></textarea>
        </div>
        <div class="flex justify-end gap-3 mt-6">
          <button type="button" id="cancel-edit-modal-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300">Cancel</button>
          <button type="submit" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Your JavaScript remains unchanged
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
  const postListContainer = document.getElementById('post-list-container');
  
  // --- Logika Filter Kategori ---
  const filterButtonsContainer = document.getElementById('filter-buttons');
  
  if(filterButtonsContainer) {
    filterButtonsContainer.addEventListener('click', function(e) {
      if (e.target.matches('.filter-btn')) {
        const filterValue = e.target.getAttribute('data-filter');
        if(this.querySelector('.active-filter')) {
          this.querySelector('.active-filter').classList.remove('active-filter');
        }
        e.target.classList.add('active-filter');
        const allPosts = postListContainer.querySelectorAll('.post-card');
        let visiblePostsCount = 0;
        allPosts.forEach(post => {
          const postCategory = post.getAttribute('data-category');
          if (filterValue === 'all' || filterValue === postCategory) {
            post.style.display = 'block';
            visiblePostsCount++;
          } else {
            post.style.display = 'none';
          }
        });
        const noPostsMessage = document.getElementById('no-posts-message');
        if (noPostsMessage) {
          noPostsMessage.style.display = (visiblePostsCount === 0 && allPosts.length > 0) ? 'block' : 'none';
        }
      }
    });
  }

  // --- Logika Create Post ---
  const showFormBtn = document.getElementById('show-form-btn');
  const createPostCard = document.getElementById('create-post-card');
  const createPostForm = document.getElementById('create-post-form');

  if(showFormBtn) {
    showFormBtn.addEventListener('click', function() {
      const isHidden = createPostCard.style.display === 'none';
      createPostCard.style.display = isHidden ? 'block' : 'none';
      
      const icon = this.querySelector('svg');
      const text = this.querySelector('span');

      if (isHidden) {
          this.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg> <span>Cancel</span>`;
          this.classList.remove('bg-blue-600', 'hover:bg-blue-700');
          this.classList.add('bg-gray-500', 'hover:bg-gray-600');
      } else {
          this.innerHTML = `<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg> <span>Create Discussion</span>`;
          this.classList.add('bg-blue-600', 'hover:bg-blue-700');
          this.classList.remove('bg-gray-500', 'hover:bg-gray-600');
      }
    });
  }

  if(createPostForm){
    createPostForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const postTitle = document.getElementById('post-title').value;
      const postContent = document.getElementById('post-content').value;
      const postCategory = document.getElementById('post-category').value;

      fetch("{% url 'forum:create_post_ajax' %}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({ title: postTitle, content: postContent, category: postCategory }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          const newPostElement = document.createElement('a');
          newPostElement.href = data.post.url;
          newPostElement.id = `post-${data.post.id}`;
          newPostElement.className = 'post-card block bg-white p-5 rounded-xl border border-gray-200 transition-shadow duration-200 hover:shadow-md';
          newPostElement.setAttribute('data-category', data.post.category_code);
          newPostElement.innerHTML = `
            <div class="flex justify-between items-start gap-4">
              <div class="flex-grow">
                  <div class="flex items-center gap-3 mb-1">
                      <h5 class="text-lg font-semibold text-gray-900 break-words">${data.post.title}</h5>
                      <span class="category-badge inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-blue-500 text-white">
                          ${data.post.category_display}
                      </span>
                  </div>
                  <p class="text-sm text-gray-600 mt-1">Started by ${data.post.author}</p>
                  <span class="text-sm font-medium text-blue-600 mt-3 inline-block">
                    View More â†’
                  </span>
              </div>
              <div class="text-right flex-shrink-0">
                <small class="text-sm text-gray-500">0 comments</small>
                <div class="flex items-center gap-3 mt-2 justify-end">
                  <button class="text-xs font-medium text-blue-600 hover:text-blue-800 edit-post-btn" data-post-id="${data.post.id}" data-post-title="${data.post.title}" data-post-content="${data.post.content}" data-post-category="${data.post.category_code}">Edit</button>
                  <button class="text-xs font-medium text-red-600 hover:text-red-800 delete-post-btn" data-post-id="${data.post.id}">Delete</button>
                </div>
              </div>
            </div>
          `;
          postListContainer.prepend(newPostElement);
          const noPostsMessage = document.getElementById('no-posts-message');
          if(noPostsMessage) noPostsMessage.remove();
          this.reset();
          showFormBtn.click(); 
        } else {
          alert(data.message || 'An error occurred.');
        }
      });
    });
  }

  // --- Logika Edit/Delete & Modal ---
  const editModal = document.getElementById('edit-post-modal');
  const editModalForm = document.getElementById('edit-post-modal-form');
  const cancelEditBtn = document.getElementById('cancel-edit-modal-btn');
  
  if(postListContainer) {
    postListContainer.addEventListener('click', function(e) {
      if (e.target.matches('.delete-post-btn') || e.target.closest('.delete-post-btn')) {
          e.preventDefault();
          e.stopPropagation();
          const button = e.target.closest('.delete-post-btn');
          const postId = button.dataset.postId;
          Swal.fire({
              title: 'Delete this discussion?',
              text: 'This action cannot be undone.',
              showCancelButton: true,
              confirmButtonText: 'Delete',
              cancelButtonText: 'Cancel',
              buttonsStyling: false,
              showClass: { popup: '' },
              hideClass: { popup: '' },
              customClass: {
                  popup: 'rounded-xl shadow-md p-6',
                  title: 'text-gray-800 font-semibold text-lg mb-2',
                  htmlContainer: 'text-gray-600 mb-4',
                  confirmButton: 'bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 mx-2',
                  cancelButton: 'bg-gray-200 text-gray-800 font-bold py-2 px-4 rounded-lg hover:bg-gray-300 mx-2'
              }
          }).then((result) => {
              if (result.isConfirmed) {
                  const url = "{% url 'forum:delete_post_ajax' 0 %}".replace('0', postId);
                  fetch(url, { method: 'POST', headers: {'X-CSRFToken': csrftoken} })
                  .then(res => res.json())
                  .then(data => {
                      if (data.status === 'success') {
                          Swal.fire({
                              title: 'This discussion has been removed.',
                              showConfirmButton: false, timer: 1200, background: '#fff',
                              showClass: { popup: '' }, hideClass: { popup: '' },
                              customClass: { title: 'text-gray-700 text-base font-medium' }
                          });
                          document.getElementById(`post-${postId}`).remove();
                      } else {
                          alert(data.message || 'Failed to delete post.');
                      }
                  });
              }
          });
      }

      if (e.target.matches('.edit-post-btn') || e.target.closest('.edit-post-btn')) {
        e.preventDefault();
        e.stopPropagation();
        const button = e.target.closest('.edit-post-btn');
        const postId = button.dataset.postId;
        const currentTitle = button.dataset.postTitle;
        const currentContent = button.dataset.postContent;
        const currentCategory = button.dataset.postCategory;
        document.getElementById('edit-post-id-input').value = postId;
        document.getElementById('edit-post-title-input').value = currentTitle;
        document.getElementById('edit-post-content-input').value = currentContent;
        document.getElementById('edit-post-category-input').value = currentCategory;
        if(editModal) editModal.style.display = 'flex';
      }
    });
  }

  if(editModalForm) {
    editModalForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const postId = document.getElementById('edit-post-id-input').value;
      const newTitle = document.getElementById('edit-post-title-input').value;
      const newContent = document.getElementById('edit-post-content-input').value;
      const newCategory = document.getElementById('edit-post-category-input').value;
      const url = "{% url 'forum:edit_post_ajax' 0 %}".replace('0', postId);
      fetch(url, {
        method: 'POST',
        headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
        body: JSON.stringify({ title: newTitle, content: newContent, category: newCategory })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === 'success') {
          const postElement = document.getElementById(`post-${postId}`);
          if(postElement) {
            postElement.querySelector('h5').textContent = data.post.title;
            postElement.querySelector('.category-badge').textContent = data.post.category_display;
            postElement.setAttribute('data-category', newCategory);
            const editBtn = postElement.querySelector('.edit-post-btn');
            if(editBtn) {
              editBtn.dataset.postTitle = data.post.title;
              editBtn.dataset.postContent = data.post.content;
              editBtn.dataset.postCategory = newCategory;
            }
          }
          if(editModal) editModal.style.display = 'none';
        } else {
          alert(data.message || 'Failed to update post.');
        }
      });
    });
  }

  if(cancelEditBtn) {
    cancelEditBtn.addEventListener('click', () => {
      if(editModal) editModal.style.display = 'none';
    });
  }
  
  if(editModal) {
    editModal.addEventListener('click', (e) => {
      if (e.target === editModal) {
        editModal.style.display = 'none';
      }
    });
  }
});
</script>
{% endblock %}