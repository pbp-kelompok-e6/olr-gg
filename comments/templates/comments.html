{% load static %}

<!-- Comments Section -->
<div class="bg-white rounded-lg shadow-md p-6 mt-8">
    <h2 class="text-2xl font-bold mb-6">Comments ({{ comments.count }})</h2>

    <!-- Add Comment Form (Only for logged in users) -->
    {% if user.is_authenticated %}
    <div class="mb-8">
        <form id="commentForm" class="space-y-4">
            {% csrf_token %}
            <input type="hidden" name="news_id" value="{{ news.id }}">
            <div>
                <textarea 
                    name="content" 
                    id="commentContent"
                    rows="4" 
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    placeholder="Write a comment..."
                    required
                ></textarea>
            </div>
            <button 
                type="submit" 
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-2 rounded-lg transition duration-200"
            >
                Post Comment
            </button>
        </form>
    </div>
    {% else %}
    <div class="bg-gray-100 border border-gray-300 rounded-lg p-4 mb-8">
        <p class="text-gray-700">
            <a href="{% url 'main:login' %}" class="text-blue-500 hover:underline">Login</a> 
            to post a comment
        </p>
    </div>
    {% endif %}

    <!-- Comments List -->
    <div id="commentsList" class="space-y-4">
        {% for comment in comments %}
        <div class="comment-item border-b border-gray-200 pb-4 last:border-b-0" data-comment-id="{{ comment.id }}">
            <!-- Comment Header -->
            <div class="flex items-start justify-between mb-2">
                <div>
                    <span class="font-semibold text-gray-800">{{ comment.user.username }}</span>
                    {% if comment.user.is_staff %}
                    <span class="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded">Admin</span>
                    {% endif %}
                    <p class="text-sm text-gray-500">
                        {{ comment.created_at|date:"F d, Y H:i" }}
                        {% if comment.updated_at != comment.created_at %}
                        <span class="italic">(edited)</span>
                        {% endif %}
                    </p>
                </div>
                
                <!-- Edit/Delete Buttons (Only for comment owner or admin) -->
                {% if user == comment.user or user.is_staff %}
                <div class="flex gap-2">
                    <button 
                        onclick="editComment('{{ comment.id }}', '{{ comment.content|escapejs }}')"
                        class="text-blue-500 hover:text-blue-700 text-sm font-medium"
                    >
                        Edit
                    </button>
                    <button 
                        onclick="deleteComment('{{ comment.id }}')"
                        class="text-red-500 hover:text-red-700 text-sm font-medium"
                    >
                        Delete
                    </button>
                </div>
                {% endif %}
            </div>

            <!-- Comment Content -->
            <div class="comment-content text-gray-700">
                <p id="content-{{ comment.id }}">{{ comment.content }}</p>
            </div>

            <!-- Edit Comment -->
            <div id="edit-form-{{ comment.id }}" class="hidden mt-3">
                <textarea 
                    id="edit-content-{{ comment.id }}"
                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                    rows="3"
                >{{ comment.content }}</textarea>
                <div class="flex gap-2 mt-2">
                    <button 
                        onclick="saveEdit('{{ comment.id }}')"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-1 rounded text-sm"
                    >
                        Save
                    </button>
                    <button 
                        onclick="cancelEdit('{{ comment.id }}')"
                        class="bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-1 rounded text-sm"
                    >
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center py-8 text-gray-500">
            <p>No comments yet. Be the first to comment!</p>
        </div>
        {% endfor %}
    </div>
</div>

<script>
// Add Comment
document.getElementById('commentForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    try {
        const response = await fetch("{% url 'berita:add_comment' %}", {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'SUCCESS') {
            location.reload(); // Reload to show new comment
        } else {
            alert(data.message || 'Failed to post comment');
        }
    } catch (error) {
        alert('Error posting comment');
        console.error(error);
    }
});

// Edit Comment - Show form
function editComment(commentId, content) {
    document.getElementById(`content-${commentId}`).classList.add('hidden');
    document.getElementById(`edit-form-${commentId}`).classList.remove('hidden');
}

// Cancel Edit
function cancelEdit(commentId) {
    document.getElementById(`content-${commentId}`).classList.remove('hidden');
    document.getElementById(`edit-form-${commentId}`).classList.add('hidden');
}

// Save Edit
async function saveEdit(commentId) {
    const content = document.getElementById(`edit-content-${commentId}`).value;
    
    if (!content.trim()) {
        alert('Comment cannot be empty');
        return;
    }
    
    const formData = new FormData();
    formData.append('content', content);
    
    try {
        const response = await fetch(`{% url 'berita:edit_comment' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', commentId), {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'SUCCESS') {
            location.reload();
        } else {
            alert(data.message || 'Failed to update comment');
        }
    } catch (error) {
        alert('Error updating comment');
        console.error(error);
    }
}

// Delete Comment
async function deleteComment(commentId) {
    if (!confirm('Are you sure you want to delete this comment?')) {
        return;
    }
    
    try {
        const response = await fetch(`{% url 'berita:delete_comment' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', commentId), {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.status === 'SUCCESS') {
            location.reload();
        } else {
            alert(data.message || 'Failed to delete comment');
        }
    } catch (error) {
        alert('Error deleting comment');
        console.error(error);
    }
}
</script>