{% extends 'base.html' %}
{% load static %}
{% block content %}
<div class="max-w-4xl mx-auto my-8" id="profile_container">
    <div class="flex items-center gap-x-4" id="nama_dan_role">
        <div>
            {% if usertarget.profile_picture %}
                <img id="profile_image_display" src="{{ usertarget.profile_picture.url }}" alt="Profile Picture" width="150" height="150" class="rounded-full h-48 w-48 object-cover">
            {% else %}
                <img id="profile_image_display" src="{% static 'image/default_profile_picture.jpg' %}" alt="Default Profile Picture" class="rounded-full h-48 w-48 object-cover">
            {% endif %}
        </div>
        <div class="">
            <div>
                <span id="profile_fullname_display" class="text-2xl font-bold">
                    {% if usertarget.first_name %} {{ usertarget.first_name }} {% endif %} {% if usertarget.last_name %} {{ usertarget.last_name }} {% endif %}
                </span>
            </div>
            <div>
                @{{ usertarget.username }}
            </div>
            <div>
                {{ usertarget.role }}
            </div>
        </div>
        <div id="button_edit" class="ml-auto">
            {% if is_owner %}
                <button id="openEditModal" 
                        class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out"
                        data-url="{% url 'users:edit_profile' %}">
                    ⚙️ Edit Profile
                </button>
            {% endif %}
        </div>
    </div>
    <div class="border-t-2 mt-4 py-4" id="about"> 
        <h3>About</h3>
        <p id="profile_bio_display">
            {% if usertarget.bio %}
                {{ usertarget.bio }}
            {% else %}
                This user has not added a bio yet.
            {% endif %}
        </p>
    </div>
    <div id="posts" class="hidden">
        <h3>Posts</h3>
    </div>
</div>

<div id="profileModalContainer">
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const modalButton = document.getElementById('openEditModal');
    const modalContainer = document.getElementById('profileModalContainer');

    // buka modalnya 
    if (modalButton) {
        modalButton.addEventListener('click', function() {
            const url = this.dataset.url;
            
            fetch(url)
                .then(response => response.text())
                .then(html => {
                    // Masukkan HTML form ke dalam container
                    modalContainer.innerHTML = html;
                    // Tampilkan modal (div #modalBackdrop sekarang ada di DOM)
                    document.getElementById('modalBackdrop').classList.remove('hidden');
                })
                .catch(error => console.error('Error fetching modal:', error));
        });
    }

    // close modalnya ama submit formnya
    modalContainer.addEventListener('click', function(e) {
        
        if (e.target.id === 'closeEditModal' || e.target.id === 'cancelEdit' || e.target.id === 'modalBackdrop') {
            modalContainer.innerHTML = ''; 
        }

    });

    modalContainer.addEventListener('submit', function(e) {
        // tombol submit 
        if (e.target.id === 'editProfileForm') {
            e.preventDefault(); 
            
            const form = e.target;
            const url = form.action;
            const formData = new FormData(form); 
            const saveButton = form.querySelector('#saveProfileButton');
            saveButton.disabled = true;
            saveButton.textContent = 'Menyimpan...';

            clearAllErrors();

            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken') 
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('profile_fullname_display').textContent = data.new_data.full_name;
                    document.getElementById('profile_bio_display').textContent = data.new_data.bio;
                    document.getElementById('profile_image_display').src = data.new_data.profile_picture_url;

                    const msgDiv = document.getElementById('form-messages');
                    msgDiv.innerHTML = `<div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded relative" role="alert">${data.message}</div>`;

                    setTimeout(() => {
                        modalContainer.innerHTML = '';
                    }, 500);

                } else if (data.status === 'error') {
                    const errors = JSON.parse(data.errors);
                    handleFormErrors(errors);
                    saveButton.disabled = false;
                    saveButton.textContent = 'Save Changes';
                }
            })
            .catch(error => {
                console.error('Error submitting form:', error);
                const msgDiv = document.getElementById('form-messages');
                msgDiv.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">Terjadi kesalahan. Coba lagi.</div>`;
                saveButton.disabled = false;
                saveButton.textContent = 'Save Changes';
            });
        }
    });

    
    function handleFormErrors(errors) {
        for (const field in errors) {
            const errorList = errors[field];
            const errorDiv = document.getElementById(`error-${field}`);
            if (errorDiv) {
                errorDiv.innerHTML = errorList.map(err => err.message).join('<br>');
            }
        }
    }

    function clearAllErrors() {
        document.querySelectorAll('[id^="error-"]').forEach(div => {
            div.innerHTML = '';
        });
        document.getElementById('form-messages').innerHTML = '';
    }

});
</script>
{% endblock content %}
